{% extends "base.html" %}

{% block title %}HA Cluster Dashboard - BOTZZZ{% endblock %}

{% block extra_head %}
<style>
    .ha-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .ha-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
    }

    .ha-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .ha-stat-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-left: 4px solid;
        transition: transform 0.2s;
    }

    .ha-stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    .ha-stat-card.healthy { border-left-color: #28a745; }
    .ha-stat-card.warning { border-left-color: #ffc107; }
    .ha-stat-card.critical { border-left-color: #dc3545; }
    .ha-stat-card.info { border-left-color: #007bff; }

    .ha-stat-title {
        font-size: 14px;
        color: #666;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 5px;
    }

    .ha-stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #333;
        margin-bottom: 5px;
    }

    .ha-stat-label {
        font-size: 12px;
        color: #888;
    }

    .ha-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .ha-panel {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .ha-panel h3 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #f8f9fa;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }

    .node-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .node-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid;
    }

    .node-item.healthy { border-left-color: #28a745; }
    .node-item.unhealthy { border-left-color: #dc3545; }
    .node-item.maintenance { border-left-color: #ffc107; }

    .node-info {
        flex: 1;
    }

    .node-name {
        font-weight: 600;
        color: #333;
    }

    .node-details {
        font-size: 12px;
        color: #666;
        margin-top: 2px;
    }

    .node-metrics {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .metric {
        text-align: center;
        font-size: 12px;
    }

    .metric-value {
        font-weight: 600;
        color: #333;
    }

    .status-badge {
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-healthy { background: #d4edda; color: #155724; }
    .status-unhealthy { background: #f8d7da; color: #721c24; }
    .status-maintenance { background: #fff3cd; color: #856404; }

    .action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 5px;
        font-size: 12px;
        cursor: pointer;
        margin: 0 2px;
        transition: all 0.2s;
    }

    .btn-primary { background: #007bff; color: white; }
    .btn-warning { background: #ffc107; color: #212529; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-success { background: #28a745; color: white; }

    .action-btn:hover {
        transform: scale(1.05);
        filter: brightness(110%);
    }

    .lb-strategy {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 15px;
        background: #f8f9fa;
        border-radius: 5px;
        margin-bottom: 10px;
    }

    .strategy-active {
        background: #d4edda;
        border-left: 3px solid #28a745;
    }

    .backup-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background: #f8f9fa;
        border-radius: 5px;
        margin-bottom: 5px;
    }

    .backup-info {
        flex: 1;
    }

    .backup-name {
        font-weight: 600;
        color: #333;
    }

    .backup-details {
        font-size: 12px;
        color: #666;
    }

    .emergency-panel {
        background: #fff5f5;
        border: 2px solid #fed7d7;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
    }

    .emergency-header {
        color: #e53e3e;
        margin-bottom: 15px;
        font-size: 18px;
        font-weight: 600;
    }

    .emergency-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .chart-container {
        position: relative;
        height: 300px;
        margin-top: 15px;
    }

    @keyframes pulse {
        0% { opacity: 0.7; }
        50% { opacity: 1; }
        100% { opacity: 0.7; }
    }

    .pulsing {
        animation: pulse 2s infinite;
    }

    .ha-full-width {
        grid-column: 1 / -1;
    }

    .region-map {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-top: 15px;
    }

    .region-card {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        transition: all 0.3s;
    }

    .region-card:hover {
        background: #e9ecef;
        transform: translateY(-2px);
    }

    .region-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
    }

    .region-nodes {
        font-size: 12px;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="ha-container">
    <div class="ha-header">
        <h1>üèóÔ∏è High Availability Cluster Dashboard</h1>
        <p>Real-time monitoring and management of BOTZZZ distributed infrastructure</p>
    </div>

    <!-- HA Statistics -->
    <div class="ha-stats">
        <div class="ha-stat-card healthy">
            <div class="ha-stat-title">Cluster Health</div>
            <div class="ha-stat-value" id="cluster-health">95%</div>
            <div class="ha-stat-label">Overall System Health</div>
        </div>
        <div class="ha-stat-card info">
            <div class="ha-stat-title">Active Nodes</div>
            <div class="ha-stat-value" id="active-nodes">12/15</div>
            <div class="ha-stat-label">Nodes Online</div>
        </div>
        <div class="ha-stat-card warning">
            <div class="ha-stat-title">Load Distribution</div>
            <div class="ha-stat-value" id="load-distribution">78%</div>
            <div class="ha-stat-label">Balanced Load</div>
        </div>
        <div class="ha-stat-card healthy">
            <div class="ha-stat-title">Uptime</div>
            <div class="ha-stat-value" id="uptime">99.9%</div>
            <div class="ha-stat-label">Last 30 Days</div>
        </div>
    </div>

    <!-- Main HA Grid -->
    <div class="ha-grid">
        <!-- Cluster Nodes -->
        <div class="ha-panel">
            <h3>üåê Cluster Nodes</h3>
            <div class="node-list" id="node-list">
                <div class="node-item healthy">
                    <div class="node-info">
                        <div class="node-name">us-east-1-prod</div>
                        <div class="node-details">Production ‚Ä¢ IP: 10.0.1.15 ‚Ä¢ Services: Captcha, Proxy</div>
                    </div>
                    <div class="node-metrics">
                        <div class="metric">
                            <div class="metric-value">85%</div>
                            <div>CPU</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">2.1GB</div>
                            <div>Memory</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">12ms</div>
                            <div>Latency</div>
                        </div>
                        <span class="status-badge status-healthy">Healthy</span>
                    </div>
                    <div>
                        <button class="action-btn btn-warning" onclick="maintainNode('us-east-1-prod')">Maintain</button>
                        <button class="action-btn btn-danger" onclick="removeNode('us-east-1-prod')">Remove</button>
                    </div>
                </div>

                <div class="node-item healthy">
                    <div class="node-info">
                        <div class="node-name">us-west-2-prod</div>
                        <div class="node-details">Production ‚Ä¢ IP: 10.0.2.22 ‚Ä¢ Services: Rate Limiting, Account Warming</div>
                    </div>
                    <div class="node-metrics">
                        <div class="metric">
                            <div class="metric-value">67%</div>
                            <div>CPU</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">1.8GB</div>
                            <div>Memory</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">8ms</div>
                            <div>Latency</div>
                        </div>
                        <span class="status-badge status-healthy">Healthy</span>
                    </div>
                    <div>
                        <button class="action-btn btn-warning" onclick="maintainNode('us-west-2-prod')">Maintain</button>
                        <button class="action-btn btn-danger" onclick="removeNode('us-west-2-prod')">Remove</button>
                    </div>
                </div>

                <div class="node-item maintenance">
                    <div class="node-info">
                        <div class="node-name">eu-west-1-staging</div>
                        <div class="node-details">Staging ‚Ä¢ IP: 10.0.3.8 ‚Ä¢ Services: Testing</div>
                    </div>
                    <div class="node-metrics">
                        <div class="metric">
                            <div class="metric-value">--</div>
                            <div>CPU</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">--</div>
                            <div>Memory</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">--</div>
                            <div>Latency</div>
                        </div>
                        <span class="status-badge status-maintenance">Maintenance</span>
                    </div>
                    <div>
                        <button class="action-btn btn-success" onclick="activateNode('eu-west-1-staging')">Activate</button>
                        <button class="action-btn btn-danger" onclick="removeNode('eu-west-1-staging')">Remove</button>
                    </div>
                </div>
            </div>
            <button class="action-btn btn-primary" style="margin-top: 15px;" onclick="addNode()">+ Add Node</button>
        </div>

        <!-- Load Balancer Status -->
        <div class="ha-panel">
            <h3>‚öñÔ∏è Load Balancing</h3>
            <div id="lb-strategies">
                <div class="lb-strategy strategy-active">
                    <div>
                        <strong>Round Robin</strong>
                        <div style="font-size: 12px; color: #666;">Active Strategy</div>
                    </div>
                    <span class="status-badge status-healthy">Active</span>
                </div>
                <div class="lb-strategy">
                    <div>
                        <strong>Least Connections</strong>
                        <div style="font-size: 12px; color: #666;">Standby</div>
                    </div>
                    <button class="action-btn btn-primary" onclick="switchStrategy('least_connections')">Activate</button>
                </div>
                <div class="lb-strategy">
                    <div>
                        <strong>Geographic</strong>
                        <div style="font-size: 12px; color: #666;">Standby</div>
                    </div>
                    <button class="action-btn btn-primary" onclick="switchStrategy('geographic')">Activate</button>
                </div>
                <div class="lb-strategy">
                    <div>
                        <strong>Response Time</strong>
                        <div style="font-size: 12px; color: #666;">Standby</div>
                    </div>
                    <button class="action-btn btn-primary" onclick="switchStrategy('response_time')">Activate</button>
                </div>
                <div class="lb-strategy">
                    <div>
                        <strong>Weighted</strong>
                        <div style="font-size: 12px; color: #666;">Standby</div>
                    </div>
                    <button class="action-btn btn-primary" onclick="switchStrategy('weighted')">Activate</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Regional Distribution -->
    <div class="ha-panel ha-full-width">
        <h3>üåç Regional Distribution</h3>
        <div class="region-map">
            <div class="region-card">
                <div class="region-name">üá∫üá∏ US East</div>
                <div class="region-nodes">4 nodes ‚Ä¢ 2 active</div>
                <div style="margin-top: 10px;">
                    <span class="status-badge status-healthy">Healthy</span>
                </div>
            </div>
            <div class="region-card">
                <div class="region-name">üá∫üá∏ US West</div>
                <div class="region-nodes">3 nodes ‚Ä¢ 3 active</div>
                <div style="margin-top: 10px;">
                    <span class="status-badge status-healthy">Healthy</span>
                </div>
            </div>
            <div class="region-card">
                <div class="region-name">üá™üá∫ EU West</div>
                <div class="region-nodes">4 nodes ‚Ä¢ 3 active</div>
                <div style="margin-top: 10px;">
                    <span class="status-badge status-warning">Degraded</span>
                </div>
            </div>
            <div class="region-card">
                <div class="region-name">üåè Asia Pacific</div>
                <div class="region-nodes">4 nodes ‚Ä¢ 4 active</div>
                <div style="margin-top: 10px;">
                    <span class="status-badge status-healthy">Healthy</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Second Row -->
    <div class="ha-grid">
        <!-- Disaster Recovery -->
        <div class="ha-panel">
            <h3>üÜò Disaster Recovery</h3>
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span><strong>RTO Target:</strong> < 5 minutes</span>
                    <span class="status-badge status-healthy">On Target</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span><strong>RPO Target:</strong> < 1 minute</span>
                    <span class="status-badge status-healthy">On Target</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span><strong>Last Backup:</strong> 2 minutes ago</span>
                    <span class="status-badge status-healthy">Current</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span><strong>Failover Status:</strong> Ready</span>
                    <span class="status-badge status-healthy">Ready</span>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <h4>Recent Backups</h4>
                <div class="backup-item">
                    <div class="backup-info">
                        <div class="backup-name">Full System Snapshot</div>
                        <div class="backup-details">Jan 15, 2025 - 14:32 UTC ‚Ä¢ 2.1GB ‚Ä¢ Verified</div>
                    </div>
                    <button class="action-btn btn-primary" onclick="restoreBackup('full-20250115-1432')">Restore</button>
                </div>
                <div class="backup-item">
                    <div class="backup-info">
                        <div class="backup-name">Database Incremental</div>
                        <div class="backup-details">Jan 15, 2025 - 14:30 UTC ‚Ä¢ 45MB ‚Ä¢ Verified</div>
                    </div>
                    <button class="action-btn btn-primary" onclick="restoreBackup('db-20250115-1430')">Restore</button>
                </div>
            </div>
        </div>

        <!-- Monitoring & Alerts -->
        <div class="ha-panel">
            <h3>üìä Cluster Monitoring</h3>
            <div id="cluster-alerts">
                <div style="display: flex; align-items: center; padding: 10px; background: #d4edda; border-radius: 5px; margin-bottom: 5px;">
                    <span style="color: #155724;">‚úÖ All systems operational</span>
                </div>
                <div style="display: flex; align-items: center; padding: 10px; background: #fff3cd; border-radius: 5px; margin-bottom: 5px;">
                    <span style="color: #856404;">‚ö†Ô∏è High memory usage on eu-west-1-staging</span>
                </div>
                <div style="display: flex; align-items: center; padding: 10px; background: #f8d7da; border-radius: 5px; margin-bottom: 5px;">
                    <span style="color: #721c24;">üî• Connection timeout in asia-pacific region</span>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <h4>Performance Metrics</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 18px; font-weight: 600; color: #28a745;">1,247</div>
                        <div style="font-size: 12px; color: #666;">Requests/min</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 18px; font-weight: 600; color: #007bff;">23ms</div>
                        <div style="font-size: 12px; color: #666;">Avg Response</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 18px; font-weight: 600; color: #ffc107;">0.02%</div>
                        <div style="font-size: 12px; color: #666;">Error Rate</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 18px; font-weight: 600; color: #17a2b8;">15.2GB</div>
                        <div style="font-size: 12px; color: #666;">Data Processed</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Emergency Controls -->
    <div class="emergency-panel">
        <div class="emergency-header">üö® Emergency Controls</div>
        <div class="emergency-actions">
            <button class="action-btn btn-danger" onclick="emergencyFailover()">üîÑ Emergency Failover</button>
            <button class="action-btn btn-warning" onclick="maintenanceMode()">üîß Maintenance Mode</button>
            <button class="action-btn btn-primary" onclick="createSnapshot()">üì∏ Create Snapshot</button>
            <button class="action-btn btn-success" onclick="healthCheck()">üè• Health Check</button>
            <button class="action-btn btn-danger" onclick="shutdownCluster()">üõë Shutdown Cluster</button>
        </div>
    </div>
</div>

<script>
// Auto-refresh dashboard data
setInterval(() => {
    refreshHADashboard();
}, 30000); // Refresh every 30 seconds

function refreshHADashboard() {
    fetch('/api/bulletproof/cluster')
        .then(response => response.json())
        .then(data => {
            updateClusterStats(data);
        })
        .catch(error => {
            console.error('Error refreshing HA dashboard:', error);
        });
}

function updateClusterStats(data) {
    // Update cluster health
    const health = document.getElementById('cluster-health');
    if (health) health.textContent = data.health + '%';

    // Update active nodes
    const nodes = document.getElementById('active-nodes');
    if (nodes) nodes.textContent = `${data.active_nodes}/${data.total_nodes}`;

    // Update load distribution
    const load = document.getElementById('load-distribution');
    if (load) load.textContent = data.load_distribution + '%';

    // Update uptime
    const uptime = document.getElementById('uptime');
    if (uptime) uptime.textContent = data.uptime + '%';
}

function maintainNode(nodeId) {
    if (confirm(`Put node ${nodeId} into maintenance mode?`)) {
        fetch(`/api/bulletproof/cluster/node/${nodeId}/maintenance`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            refreshHADashboard();
        });
    }
}

function removeNode(nodeId) {
    if (confirm(`Remove node ${nodeId} from cluster? This action cannot be undone.`)) {
        fetch(`/api/bulletproof/cluster/node/${nodeId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            refreshHADashboard();
        });
    }
}

function activateNode(nodeId) {
    fetch(`/api/bulletproof/cluster/node/${nodeId}/activate`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        refreshHADashboard();
    });
}

function addNode() {
    const region = prompt('Enter region (us-east, us-west, eu-west, asia-pacific):');
    const services = prompt('Enter services (comma-separated):');
    
    if (region && services) {
        fetch('/api/bulletproof/cluster/node', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                region: region,
                services: services.split(',').map(s => s.trim())
            })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            refreshHADashboard();
        });
    }
}

function switchStrategy(strategy) {
    if (confirm(`Switch load balancing strategy to ${strategy}?`)) {
        fetch('/api/bulletproof/cluster/load-balancer/strategy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ strategy: strategy })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            refreshHADashboard();
        });
    }
}

function emergencyFailover() {
    if (confirm('Trigger emergency failover? This will redirect all traffic to backup nodes.')) {
        fetch('/api/bulletproof/disaster-recovery/failover', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            refreshHADashboard();
        });
    }
}

function maintenanceMode() {
    if (confirm('Enable cluster-wide maintenance mode? This will temporarily disable all services.')) {
        fetch('/api/bulletproof/cluster/maintenance', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            refreshHADashboard();
        });
    }
}

function createSnapshot() {
    if (confirm('Create a full system snapshot? This may take several minutes.')) {
        fetch('/api/bulletproof/disaster-recovery/backup', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            refreshHADashboard();
        });
    }
}

function healthCheck() {
    fetch('/api/bulletproof/cluster/health-check', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        alert(`Health Check Results:\n${JSON.stringify(data, null, 2)}`);
    });
}

function shutdownCluster() {
    if (confirm('DANGER: Shutdown entire cluster? This will stop all services immediately.')) {
        if (confirm('Are you absolutely sure? This action will cause downtime.')) {
            fetch('/api/bulletproof/cluster/shutdown', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
            });
        }
    }
}

function restoreBackup(backupId) {
    if (confirm(`Restore from backup ${backupId}? This will overwrite current data.`)) {
        fetch(`/api/bulletproof/disaster-recovery/restore/${backupId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            refreshHADashboard();
        });
    }
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    refreshHADashboard();
});
</script>
{% endblock %}
