// Authentication System with Production Security
// bcrypt.js for password hashing
// CryptoJS for token encryption
// JWT-like token system with expiration

// Security Constants
const SALT_ROUNDS = 10;
const TOKEN_EXPIRY_HOURS = 24;
const TOKEN_EXPIRY_REMEMBER = 30 * 24; // 30 days
const MAX_LOGIN_ATTEMPTS = 5;
const LOCKOUT_DURATION = 15 * 60 * 1000; // 15 minutes

// Rate limiting storage
const loginAttempts = {};

// Sign In Form Handler
if (document.getElementById('signinForm')) {
    document.getElementById('signinForm').addEventListener('submit', handleSignIn);
}

// Sign Up Form Handler
if (document.getElementById('signupForm')) {
    document.getElementById('signupForm').addEventListener('submit', handleSignUp);
}

// Security Helper: Check rate limiting
function checkRateLimit(email) {
    const now = Date.now();
    const attempts = loginAttempts[email] || { count: 0, lockedUntil: 0 };
    
    // Check if locked out
    if (attempts.lockedUntil > now) {
        const minutesLeft = Math.ceil((attempts.lockedUntil - now) / 60000);
        return { allowed: false, message: `Too many failed attempts. Try again in ${minutesLeft} minutes.` };
    }
    
    // Reset if lockout expired
    if (attempts.lockedUntil > 0 && attempts.lockedUntil <= now) {
        loginAttempts[email] = { count: 0, lockedUntil: 0 };
    }
    
    return { allowed: true };
}

// Security Helper: Record failed attempt
function recordFailedAttempt(email) {
    const now = Date.now();
    if (!loginAttempts[email]) {
        loginAttempts[email] = { count: 0, lockedUntil: 0 };
    }
    
    loginAttempts[email].count++;
    
    if (loginAttempts[email].count >= MAX_LOGIN_ATTEMPTS) {
        loginAttempts[email].lockedUntil = now + LOCKOUT_DURATION;
        return { locked: true, count: loginAttempts[email].count };
    }
    
    return { locked: false, count: loginAttempts[email].count };
}

// Security Helper: Clear attempts on successful login
function clearLoginAttempts(email) {
    delete loginAttempts[email];
}

// Security Helper: Generate secure token
function generateSecureToken(user, rememberMe) {
    const expiryHours = rememberMe ? TOKEN_EXPIRY_REMEMBER : TOKEN_EXPIRY_HOURS;
    const expiryTime = Date.now() + (expiryHours * 60 * 60 * 1000);
    
    const tokenData = {
        userId: user.id,
        email: user.email,
        fullname: user.fullname,
        exp: expiryTime,
        iat: Date.now()
    };
    
    // Encrypt token with CryptoJS
    const encrypted = CryptoJS.AES.encrypt(JSON.stringify(tokenData), user.email).toString();
    return encrypted;
}

// Security Helper: Verify token
function verifyToken(token, email) {
    try {
        const decrypted = CryptoJS.AES.decrypt(token, email).toString(CryptoJS.enc.Utf8);
        if (!decrypted) return null;
        
        const tokenData = JSON.parse(decrypted);
        
        // Check expiry
        if (tokenData.exp < Date.now()) {
            return null;
        }
        
        return tokenData;
    } catch (error) {
        return null;
    }
}

// Handle Sign In with Security
function handleSignIn(e) {
    e.preventDefault();
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const rememberMe = document.getElementById('rememberMe')?.checked || false;
    
    // Input sanitization
    const sanitizedEmail = email.toLowerCase().trim();
    
    // Check rate limiting
    const rateCheck = checkRateLimit(sanitizedEmail);
    if (!rateCheck.allowed) {
        showError(rateCheck.message);
        return;
    }
    
    // Get stored users
    const users = JSON.parse(localStorage.getItem('USERS') || '[]');
    
    // Find user
    const user = users.find(u => u.email === sanitizedEmail);
    
    if (!user) {
        recordFailedAttempt(sanitizedEmail);
        showError('Invalid email or password');
        return;
    }
    
    // Verify password with bcrypt
    try {
        const passwordMatch = bcrypt.compareSync(password, user.password);
        
        if (!passwordMatch) {
            const attempt = recordFailedAttempt(sanitizedEmail);
            if (attempt.locked) {
                showError('Too many failed attempts. Account locked for 15 minutes.');
            } else {
                showError(`Invalid email or password. ${MAX_LOGIN_ATTEMPTS - attempt.count} attempts remaining.`);
            }
            return;
        }
    } catch (error) {
        showError('Authentication error. Please try again.');
        return;
    }
    
    // Clear failed attempts
    clearLoginAttempts(sanitizedEmail);
    
    // Generate secure token
    const secureToken = generateSecureToken(user, rememberMe);
    
    // Create session
    const session = {
        token: secureToken,
        email: user.email,
        userId: user.id,
        loggedInAt: new Date().toISOString()
    };
    
    localStorage.setItem('USER_SESSION', JSON.stringify(session));
    
    // Show success and redirect
    showSuccess('Sign in successful! Redirecting...');
    
    setTimeout(() => {
        window.location.href = 'index.html';
    }, 1500);
}

// Handle Sign Up with Security
function handleSignUp(e) {
    e.preventDefault();
    
    const fullname = document.getElementById('fullname').value;
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const agreeTerms = document.getElementById('agreeTerms').checked;
    
    // Input sanitization
    const sanitizedEmail = email.toLowerCase().trim();
    const sanitizedFullname = fullname.trim();
    
    // Enhanced validation
    if (password !== confirmPassword) {
        showError('Passwords do not match');
        return;
    }
    
    if (password.length < 8) {
        showError('Password must be at least 8 characters');
        return;
    }
    
    // Password strength check
    const hasUpperCase = /[A-Z]/.test(password);
    const hasLowerCase = /[a-z]/.test(password);
    const hasNumber = /[0-9]/.test(password);
    
    if (!hasUpperCase || !hasLowerCase || !hasNumber) {
        showError('Password must contain uppercase, lowercase, and numbers');
        return;
    }
    
    if (!agreeTerms) {
        showError('You must agree to the Terms of Service');
        return;
    }
    
    // Get stored users
    const users = JSON.parse(localStorage.getItem('USERS') || '[]');
    
    // Check if email already exists
    if (users.find(u => u.email === sanitizedEmail)) {
        showError('An account with this email already exists');
        return;
    }
    
    // Hash password with bcrypt
    let hashedPassword;
    try {
        hashedPassword = bcrypt.hashSync(password, SALT_ROUNDS);
    } catch (error) {
        showError('Error creating account. Please try again.');
        return;
    }
    
    // Create new user
    const newUser = {
        id: generateUserId(),
        fullname: sanitizedFullname,
        email: sanitizedEmail,
        password: hashedPassword, // SECURE: bcrypt hashed password
        createdAt: new Date().toISOString(),
        balance: 5.00 // Welcome bonus
    };
    
    users.push(newUser);
    localStorage.setItem('USERS', JSON.stringify(users));
    
    // Generate secure token
    const secureToken = generateSecureToken(newUser, true);
    
    // Create session
    const session = {
        token: secureToken,
        email: newUser.email,
        userId: newUser.id,
        loggedInAt: new Date().toISOString()
    };
    
    localStorage.setItem('USER_SESSION', JSON.stringify(session));
    
    // Show success and redirect
    showSuccess('Account created successfully! Welcome bonus: $5.00');
    
    setTimeout(() => {
        window.location.href = 'index.html';
    }, 2000);
}

// Toggle Password Visibility
function togglePassword() {
    const passwordInput = document.getElementById('password');
    const type = passwordInput.type === 'password' ? 'text' : 'password';
    passwordInput.type = type;
}

function toggleConfirmPassword() {
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const type = confirmPasswordInput.type === 'password' ? 'text' : 'password';
    confirmPasswordInput.type = type;
}

// Google Sign-In Implementation
function initGoogleSignIn() {
    // Show info about setting up Google OAuth
    const instructions = `
To enable Google Sign-In:

1. Go to Google Cloud Console: https://console.cloud.google.com
2. Create a new project or select existing one
3. Enable Google+ API
4. Go to Credentials → Create OAuth 2.0 Client ID
5. Set Authorized JavaScript origins: http://localhost, https://yourdomain.com
6. Set Authorized redirect URIs: http://localhost/signin.html, https://yourdomain.com/signin.html
7. Copy your Client ID
8. Replace 'YOUR_GOOGLE_CLIENT_ID' in signin.html and signup.html

For now, you can use the demo mode below.
    `;
    
    if (confirm(instructions + '\n\nUse demo Google Sign-In for now?')) {
        demoGoogleSignIn();
    }
}

// Demo Google Sign-In (for development/testing)
function demoGoogleSignIn() {
    // Simulate Google user data
    const demoGoogleUser = {
        email: 'demo@gmail.com',
        fullname: 'Demo User',
        picture: 'https://ui-avatars.com/api/?name=Demo+User&background=FF1494&color=fff'
    };
    
    // Check if user exists
    const users = JSON.parse(localStorage.getItem('USERS') || '[]');
    let user = users.find(u => u.email === demoGoogleUser.email);
    
    if (!user) {
        // Create new user from Google account
        user = {
            id: generateUserId(),
            fullname: demoGoogleUser.fullname,
            email: demoGoogleUser.email,
            picture: demoGoogleUser.picture,
            authProvider: 'google',
            createdAt: new Date().toISOString(),
            balance: 5.00 // Welcome bonus
        };
        
        users.push(user);
        localStorage.setItem('USERS', JSON.stringify(users));
        
        showSuccess('Account created with Google! Welcome bonus: $5.00');
    } else {
        showSuccess('Signed in with Google!');
    }
    
    // Create session
    const session = {
        userId: user.id,
        email: user.email,
        fullname: user.fullname,
        picture: user.picture,
        authProvider: 'google',
        loggedInAt: new Date().toISOString(),
        rememberMe: true
    };
    
    localStorage.setItem('USER_SESSION', JSON.stringify(session));
    
    // Redirect
    setTimeout(() => {
        window.location.href = 'index.html';
    }, 1500);
}

// Handle Google Sign-In Callback (for real Google OAuth)
function handleGoogleSignIn(response) {
    // Decode the JWT token
    const userObject = parseJwt(response.credential);
    
    console.log('Google User:', userObject);
    
    // Check if user exists
    const users = JSON.parse(localStorage.getItem('USERS') || '[]');
    let user = users.find(u => u.email === userObject.email);
    
    if (!user) {
        // Create new user from Google account
        user = {
            id: generateUserId(),
            fullname: userObject.name,
            email: userObject.email,
            picture: userObject.picture,
            authProvider: 'google',
            googleId: userObject.sub,
            createdAt: new Date().toISOString(),
            balance: 5.00 // Welcome bonus
        };
        
        users.push(user);
        localStorage.setItem('USERS', JSON.stringify(users));
        
        showSuccess('Account created with Google! Welcome bonus: $5.00');
    } else {
        showSuccess('Signed in with Google!');
    }
    
    // Create session
    const session = {
        userId: user.id,
        email: user.email,
        fullname: user.fullname,
        picture: user.picture,
        authProvider: 'google',
        loggedInAt: new Date().toISOString(),
        rememberMe: true
    };
    
    localStorage.setItem('USER_SESSION', JSON.stringify(session));
    
    // Redirect
    setTimeout(() => {
        window.location.href = 'index.html';
    }, 1500);
}

// Parse JWT Token
function parseJwt(token) {
    try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        
        return JSON.parse(jsonPayload);
    } catch (e) {
        console.error('Failed to parse JWT:', e);
        return null;
    }
}

// Social Sign In (Legacy - kept for compatibility)
function socialSignIn(provider) {
    if (provider === 'google') {
        initGoogleSignIn();
    } else {
        showSuccess(`${provider} sign in coming soon!`);
    }
}

// Show Error Message
function showError(message) {
    // Remove any existing messages
    removeMessages();
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message show';
    errorDiv.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <span>${message}</span>
    `;
    
    const form = document.querySelector('.auth-form');
    form.insertBefore(errorDiv, form.firstChild);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        errorDiv.remove();
    }, 5000);
}

// Show Success Message
function showSuccess(message) {
    // Remove any existing messages
    removeMessages();
    
    const successDiv = document.createElement('div');
    successDiv.className = 'success-message show';
    successDiv.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        <span>${message}</span>
    `;
    
    const form = document.querySelector('.auth-form');
    form.insertBefore(successDiv, form.firstChild);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        successDiv.remove();
    }, 5000);
}

// Remove all messages
function removeMessages() {
    const messages = document.querySelectorAll('.error-message, .success-message');
    messages.forEach(msg => msg.remove());
}

// Generate User ID
function generateUserId() {
    return 'USER_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// Check if user is logged in (with token validation)
function isLoggedIn() {
    const session = localStorage.getItem('USER_SESSION');
    if (!session) return false;
    
    try {
        const sessionData = JSON.parse(session);
        if (!sessionData.token || !sessionData.email) return false;
        
        // Verify token
        const tokenData = verifyToken(sessionData.token, sessionData.email);
        if (!tokenData) {
            // Token expired or invalid
            localStorage.removeItem('USER_SESSION');
            return false;
        }
        
        return true;
    } catch (error) {
        localStorage.removeItem('USER_SESSION');
        return false;
    }
}

// Get current user (with token validation)
function getCurrentUser() {
    const session = localStorage.getItem('USER_SESSION');
    if (!session) return null;
    
    try {
        const sessionData = JSON.parse(session);
        if (!sessionData.token || !sessionData.email) return null;
        
        // Verify token
        const tokenData = verifyToken(sessionData.token, sessionData.email);
        if (!tokenData) {
            // Token expired or invalid
            localStorage.removeItem('USER_SESSION');
            return null;
        }
        
        // Get user from storage
        const users = JSON.parse(localStorage.getItem('USERS') || '[]');
        return users.find(u => u.id === tokenData.userId);
    } catch (error) {
        localStorage.removeItem('USER_SESSION');
        return null;
    }
}

// Logout
function logout() {
    localStorage.removeItem('USER_SESSION');
    window.location.href = 'signin.html';
}

// Update navigation for logged-in users
function updateNavigation() {
    if (!isLoggedIn()) return;
    
    const user = getCurrentUser();
    if (!user) return;
    
    // Check if user is admin (for demo, admin@botzzz773.com or username contains 'admin')
    const isAdmin = user.email === 'admin@botzzz773.com' || user.username.toLowerCase().includes('admin');
    
    // Update Sign In button to show user menu
    const signInButtons = document.querySelectorAll('.btn-primary');
    signInButtons.forEach(btn => {
        if (btn.textContent.includes('Sign In') || btn.textContent.includes('Sign Up')) {
            const firstName = user.fullname.split(' ')[0];
            btn.textContent = firstName + ' ▾';
            btn.href = '#';
            btn.style.position = 'relative';
            btn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // Create dropdown menu if not exists
                let dropdown = btn.nextElementSibling;
                if (!dropdown || !dropdown.classList.contains('user-dropdown-menu')) {
                    dropdown = document.createElement('div');
                    dropdown.className = 'user-dropdown-menu';
                    dropdown.innerHTML = `
                        <a href="order.html">New Order</a>
                        <a href="tickets.html">My Tickets</a>
                        <a href="api-dashboard.html">API Keys</a>
                        ${isAdmin ? '<a href="admin/index.html">Admin Panel</a>' : ''}
                        <hr style="margin: 8px 0; border: 1px solid #2a2a2a;">
                        <a href="#" onclick="logout(); return false;">Logout</a>
                    `;
                    dropdown.style.cssText = `
                        position: absolute;
                        top: 100%;
                        right: 0;
                        background: #1a1a1a;
                        border: 1px solid #2a2a2a;
                        border-radius: 8px;
                        min-width: 180px;
                        padding: 8px 0;
                        margin-top: 8px;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                        z-index: 1000;
                        display: none;
                    `;
                    btn.parentElement.style.position = 'relative';
                    btn.parentElement.appendChild(dropdown);
                    
                    // Style dropdown links
                    dropdown.querySelectorAll('a').forEach(link => {
                        link.style.cssText = `
                            display: block;
                            padding: 10px 16px;
                            color: #ffffff;
                            text-decoration: none;
                            transition: background 0.2s;
                        `;
                        link.onmouseenter = () => link.style.background = '#2d2d2d';
                        link.onmouseleave = () => link.style.background = 'transparent';
                    });
                }
                
                // Toggle dropdown
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                
                // Close on outside click
                setTimeout(() => {
                    document.addEventListener('click', function closeDropdown() {
                        dropdown.style.display = 'none';
                        document.removeEventListener('click', closeDropdown);
                    });
                }, 100);
            };
        }
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    // Redirect if already logged in and on auth pages
    if (isLoggedIn() && (window.location.pathname.includes('signin.html') || window.location.pathname.includes('signup.html'))) {
        window.location.href = 'index.html';
    }
    
    // Update navigation on all pages
    updateNavigation();
});
